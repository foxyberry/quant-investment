# 포트폴리오 모니터링 시스템 (Portfolio Monitoring)

- **날짜**: 2026-01-28
- **이슈**: #7, #18-26
- **브랜치**: `feature/issue18`
- **상태**: 완료

## 목표

실시간 포트폴리오 모니터링 및 조건 기반 자동 매매 시스템 구축

## 배경

- 기존 `screener/portfolio_manager.py`에 기본 보유 종목 관리 기능 존재
- 실시간 가격 모니터링, 조건 트리거, 자동 매매 기능 부재
- 알림 시스템 필요

## 이슈 의존성

```
#18 Holdings Management ─────┐
                             ├──► #20 Condition Trigger ──┐
#19 Price Monitoring ────────┘                            │
                                                          ├──► #23 Paper Trading ──► #24 Live Order
#21 Trading Condition IoC ────────────────────────────────┤
                                                          │
#22 Quantity Configuration ───────────────────────────────┘

#25 Risk Management ──► (#23, #24에 적용)

#26 Notification ──► (#20 의존)
```

## 계획

### Phase 1: 기반 구축
- [x] **#18** Holdings Management
  - 기존 `screener/portfolio_manager.py` → `portfolio/holdings.py` 이동
  - 평균 매수가 자동 계산 추가
  - 부분 매도 지원
- [x] **#19** Price Monitoring
  - 폴링 기반 가격 모니터링
  - 콜백 이벤트 시스템
  - 멀티 종목 지원

### Phase 2: 조건 감지
- [x] **#20** Condition Trigger Detection
  - 가격 목표 도달 감지
  - 쿨다운 기간 설정
  - 이벤트 로깅
- [x] **#21** Trading Condition IoC Pattern
  - `TradingCondition` 프로토콜 정의
  - 기본 조건 구현 (손절, 익절, 트레일링)
  - 조건 체이닝

### Phase 3: 주문 실행
- [x] **#22** Buy/Sell Quantity Configuration
  - 고정 수량, 퍼센트, 금액 기반 계산
  - 최소 주문 수량 처리
- [x] **#23** Paper Trading (Dry-run)
  - 모의 주문 실행
  - 가상 포트폴리오 업데이트
  - 거래 로그 생성

### Phase 4: 확장
- [x] **#24** Live Order Execution
  - 인터페이스 구현 (브로커 연동은 사용자 구현)
- [x] **#25** Risk Management Rules Engine
  - 최대 포지션 한도
  - 일일 손실 한도
- [x] **#26** Notification System
  - 텔레그램, Slack, 콘솔 지원

## 변경 파일

### 신규 생성

| 파일 | 설명 | 이슈 |
|------|------|------|
| `portfolio/__init__.py` | 포트폴리오 모듈 진입점 | - |
| `portfolio/holdings.py` | 보유 종목 관리 | #18 |
| `portfolio/monitor.py` | 가격 모니터링 | #19 |
| `portfolio/trigger.py` | 조건 트리거 감지 | #20 |
| `portfolio/conditions.py` | 매매 조건 인터페이스 | #21 |
| `portfolio/quantity.py` | 수량 계산 | #22 |
| `portfolio/executor.py` | 주문 실행 (Paper/Live) | #23, #24 |
| `portfolio/risk.py` | 위험 관리 | #25 |
| `portfolio/notifier.py` | 알림 시스템 | #26 |

### 수정/삭제

| 파일 | 변경 내용 |
|------|----------|
| `screener/portfolio_manager.py` | `portfolio/` 모듈로 이동 후 삭제 또는 import 래퍼로 변경 |

## 기술적 고려사항

### 기존 코드 활용
- `screener/portfolio_manager.py` - `Holding`, `SellConditions`, `PortfolioManager` 클래스 재활용
- `models/price_target.py` - 가격 목표 연동

### 비동기 처리
- Price Monitor: `threading` 또는 `asyncio` 사용
- API 호출 시 rate limit 준수

### 설정 파일
- `config/portfolio.yaml` - 보유 종목
- `config/trading_config.yaml` - 매매 설정 (신규)

## Acceptance Criteria 요약

**#18 Holdings:**
```python
portfolio = Portfolio()
portfolio.add("005930", quantity=10, avg_price=70000)
assert portfolio.get("005930").quantity == 10
```

**#19 Monitoring:**
```python
monitor = PriceMonitor(interval=10)
monitor.add("005930")
monitor.on_update(callback)
monitor.start()
```

**#20 Trigger:**
```python
checker = ConditionChecker()
checker.add_condition("005930", "PRICE_ABOVE", 80000)
checker.on_triggered(alert)
```

**#23 Paper Trading:**
```python
order = Order("005930", "SELL", quantity=5)
result = executor.execute(order, dry_run=True)
assert result.simulated == True
```

## 결과

### 구현 완료 (2026-01-28)

**커밋**: `5868d38`

**생성된 모듈:**

| 파일 | 이슈 | 설명 |
|------|------|------|
| `portfolio/holdings.py` | #18 | 보유 종목 CRUD, 평균가 계산 |
| `portfolio/monitor.py` | #19 | 폴링 기반 가격 모니터링 |
| `portfolio/trigger.py` | #20 | 조건 트리거 감지 |
| `portfolio/conditions.py` | #21 | 매매 조건 IoC 패턴 |
| `portfolio/quantity.py` | #22 | 수량 계산 로직 |
| `portfolio/executor.py` | #23, #24 | Paper/Live 주문 실행 |
| `portfolio/risk.py` | #25 | 위험 관리 규칙 |
| `portfolio/notifier.py` | #26 | 알림 시스템 |

**사용 예시:**
```python
from portfolio import (
    Portfolio, PriceMonitor, ConditionChecker,
    OrderExecutor, Order, create_default_risk_manager
)

# 포트폴리오 관리
portfolio = Portfolio()
portfolio.add("005930.KS", quantity=10, avg_price=70000)

# Paper Trading
executor = OrderExecutor(dry_run=True)
order = Order("005930.KS", "SELL", quantity=5)
result = executor.execute(order, market_price=80000)

# 위험 관리
risk = create_default_risk_manager()
validation = risk.validate_order(...)
```

**종료된 이슈:** #7, #18-26
