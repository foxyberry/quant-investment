# 백테스팅 프레임워크 구축

- **날짜**: 2026-01-28
- **이슈**: #5, #8, #9
- **브랜치**: `feature/issue8`
- **상태**: 완료

## 목표

백테스팅 프레임워크 선정 및 구현, 전략 성능 지표 계산 시스템 구축

## 배경

- backtrader 제거 후 새로운 백테스팅 프레임워크 필요
- 기존 스크리닝 조건을 백테스트에 연결할 수 있어야 함
- 한국(KRX) 및 미국 시장 모두 지원 필요

## 프레임워크 비교

### VectorBT vs Backtesting.py

| 기준 | VectorBT | Backtesting.py |
|------|----------|----------------|
| 속도 | ⭐⭐⭐⭐⭐ (벡터 연산) | ⭐⭐⭐ |
| 사용 편의성 | ⭐⭐ (학습 곡선 높음) | ⭐⭐⭐⭐⭐ |
| 파라미터 최적화 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 무료 기능 | 일부 Pro 유료 | 전체 무료 |
| 문서화 | 좋음 | 매우 좋음 |

### 선정: Backtesting.py

**이유:**
1. 학습 곡선이 낮아 빠르게 구현 가능
2. 전체 기능 무료
3. 직관적인 API
4. 활발한 커뮤니티 지원

**향후 계획:**
- 대규모 파라미터 최적화가 필요하면 VectorBT로 전환 고려

## 계획

### Phase 1: 프레임워크 설정 (Issue #8)
- [x] 1단계: Backtesting.py 설치 및 의존성 추가
- [x] 2단계: 기본 백테스트 엔진 클래스 구현
  - `engine/backtesting_engine.py`
- [x] 3단계: 샘플 전략 구현 (MA 크로스오버)
- [x] 4단계: 스크리닝 조건 → 백테스트 파이프라인 연결

### Phase 2: 성능 지표 계산 (Issue #9)
- [x] 5단계: 성능 지표 계산 모듈 구현
  - Sharpe Ratio
  - Sortino Ratio
  - Maximum Drawdown (MDD)
  - Win Rate & Profit Factor
  - CAGR
- [x] 6단계: 결과 출력 포맷 구현

### Phase 3: 검증
- [x] 7단계: 한국 주식 (삼성전자 005930) 백테스트
- [x] 8단계: 미국 주식 (AAPL) 백테스트
- [ ] 9단계: 기존 스크리닝 조건으로 백테스트 실행 (향후)

## 변경 파일

### 신규 생성

| 파일 | 설명 |
|------|------|
| `engine/backtesting_engine.py` | 백테스팅 엔진 래퍼 |
| `engine/strategies/ma_cross.py` | MA 크로스오버 전략 |
| `engine/metrics.py` | 성능 지표 계산 모듈 |
| `scripts/backtesting/run_backtest.py` | 백테스트 실행 스크립트 |

### 수정

| 파일 | 변경 내용 |
|------|----------|
| `requirements.txt` | Backtesting 의존성 추가 |

## 기술적 고려사항

### 데이터 소스
- 한국: pykrx (이미 사용 중)
- 미국: yfinance (이미 사용 중)

### Acceptance Criteria (Issue #8)
```python
result = backtest(strategy=ma_touch_strategy, ticker="005930", period="1y")
assert result.total_return is not None
assert result.trades is not None
```

### Acceptance Criteria (Issue #9)
```python
metrics = calculate_metrics(backtest_result)
assert "sharpe_ratio" in metrics
assert "sortino_ratio" in metrics
assert "mdd" in metrics
assert "win_rate" in metrics
assert "profit_factor" in metrics
```

### 메모리 고려
- 대규모 백테스트 시 메모리 사용량 모니터링
- 필요시 청크 단위 처리

## 참고 자료

- [Backtesting.py 공식 문서](https://kernc.github.io/backtesting.py/)
- [VectorBT 공식 문서](https://vectorbt.dev/)
- [VectorBT vs Backtrader 비교](https://greyhoundanalytics.com/blog/vectorbt-vs-backtrader/)

## 결과

### 생성된 파일
- `engine/__init__.py` - 모듈 초기화
- `engine/backtesting_engine.py` - 백테스팅 엔진 래퍼 (BacktestEngine, BacktestResult)
- `engine/metrics.py` - 성능 지표 계산 (calculate_metrics, PerformanceMetrics)
- `engine/strategies/__init__.py` - 전략 모듈 초기화
- `engine/strategies/ma_cross.py` - MA 크로스오버 전략 (SmaCross, EmaCross, MaTouchStrategy)
- `scripts/backtesting/run_backtest.py` - CLI 백테스트 실행 스크립트

### 수정된 파일
- `requirements.txt` - Backtesting>=0.6.0, bokeh>=3.0.0 추가

### 검증 결과

**삼성전자 (005930.KS) - SMA 전략**
```
Total Return:    25.12%
CAGR:            25.38%
Sharpe Ratio:    0.78
Max Drawdown:    42.66%
Win Rate:        25.00%
# Trades:        12
```

**AAPL - EMA 전략**
```
Total Return:    -10.07%
CAGR:            -10.11%
Sharpe Ratio:    -0.33
Max Drawdown:    41.78%
Win Rate:        27.27%
# Trades:        11
```

### Acceptance Criteria
- Issue #8: ✅ PASSED
- Issue #9: ✅ PASSED

### 사용법
```bash
# 기본 백테스트
python scripts/backtesting/run_backtest.py --ticker 005930.KS --period 1y

# 전략 및 파라미터 지정
python scripts/backtesting/run_backtest.py --ticker AAPL --strategy ema --n1 12 --n2 26

# 파라미터 최적화
python scripts/backtesting/run_backtest.py --ticker 005930.KS --optimize
```
